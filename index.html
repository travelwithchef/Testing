<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ultra-HD Image Enhancer</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/esrgan-tfjs@0.1.2/dist/esrgan.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    img, canvas { max-width: 100%; margin-top: 20px; border: 1px solid #ccc; }
    button { margin-top: 10px; }
  </style>
</head>
<body>

  <h2>Ultra-HD Image Enhancer (4x)</h2>

  <input type="file" id="fileInput" accept="image/*"><br>
  <img id="inputImage" src="" alt="Input Image" />
  <br>
  <button id="enhanceBtn" disabled>Enhance Image</button>
  <canvas id="outputCanvas" style="display: none;"></canvas>
  <img id="outputImage" src="" alt="Enhanced Image" />
  <br>
  <a id="downloadLink" href="#" download="enhanced.png" style="display: none;">Download Ultra-HD Image</a>

  <script>
    const fileInput = document.getElementById('fileInput');
    const inputImage = document.getElementById('inputImage');
    const enhanceBtn = document.getElementById('enhanceBtn');
    const outputCanvas = document.getElementById('outputCanvas');
    const outputImage = document.getElementById('outputImage');
    const downloadLink = document.getElementById('downloadLink');
    let model;

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        inputImage.src = reader.result;
        enhanceBtn.disabled = false;
        outputImage.src = '';
        downloadLink.style.display = 'none';
      };
      reader.readAsDataURL(file);
    });

    enhanceBtn.addEventListener('click', async () => {
      if (!inputImage.src) return;

      enhanceBtn.disabled = true;
      enhanceBtn.textContent = 'Loading model...';

      // Load model once
      if (!model) {
        model = await ESRGAN.load();
        console.log('Model loaded');
      }

      enhanceBtn.textContent = 'Enhancing... (please wait)';

      // Create temp canvas
      const tempCanvas = document.createElement('canvas');
      const ctx = tempCanvas.getContext('2d');
      tempCanvas.width = inputImage.naturalWidth;
      tempCanvas.height = inputImage.naturalHeight;
      ctx.drawImage(inputImage, 0, 0);

      // Convert to tensor
      const inputTensor = tf.browser.fromPixels(tempCanvas);
      console.log('Original size:', inputTensor.shape);

      try {
        const outputTensor = await model.predict(inputTensor);
        console.log('Enhanced size:', outputTensor.shape);

        outputCanvas.width = outputTensor.shape[1];
        outputCanvas.height = outputTensor.shape[0];
        await tf.browser.toPixels(outputTensor, outputCanvas);

        const dataURL = outputCanvas.toDataURL('image/png');
        outputImage.src = dataURL;
        downloadLink.href = dataURL;
        downloadLink.style.display = 'inline-block';

        outputTensor.dispose();
      } catch (err) {
        alert('Error enhancing image: ' + err.message);
        console.error(err);
      }

      inputTensor.dispose();
      enhanceBtn.textContent = 'Enhance Image';
      enhanceBtn.disabled = false;
    });
  </script>

</body>
</html>
