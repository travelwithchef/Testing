<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Greenery Analyzer - Debug</title>
  <style>
    body {
      background-color: #121212;
      color: #f1f1f1;
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
    }
    input, button {
      margin: 1rem;
      padding: 0.6rem;
      font-size: 1rem;
    }
    canvas {
      margin-top: 2rem;
      border: 2px solid #333;
    }
    .result {
      margin-top: 1rem;
      font-size: 1.2rem;
      color: #00ff99;
    }
  </style>
</head>
<body>
  <h1>Greenery Debug Analyzer</h1>
  <input type="file" id="imageUpload" accept="image/*" />
  <input type="color" id="colorInput" value="#228B22" />
  <button onclick="analyzeColor()">Analyze</button>
  <div class="result" id="outputText">Awaiting image...</div>
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const colorInput = document.getElementById("colorInput");

    let img = new Image();

    document.getElementById("imageUpload").addEventListener("change", function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        img.onload = function () {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          canvas.style.display = "block";
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    function hexToRGB(hex) {
      hex = hex.replace("#", "");
      const bigint = parseInt(hex, 16);
      return {
        r: (bigint >> 16) & 255,
        g: (bigint >> 8) & 255,
        b: bigint & 255,
      };
    }

    function rgbToLab({ r, g, b }) {
      function pivot(n) {
        return n > 0.008856 ? Math.pow(n, 1 / 3) : (7.787 * n) + 16 / 116;
      }

      r /= 255; g /= 255; b /= 255;
      r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
      g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
      b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

      const x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
      const y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.0000;
      const z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;

      const L = (116 * pivot(y)) - 16;
      const a = 500 * (pivot(x) - pivot(y));
      const bVal = 200 * (pivot(y) - pivot(z));
      return { L, a, b: bVal };
    }

    function deltaE(lab1, lab2) {
      return Math.sqrt(
        Math.pow(lab1.L - lab2.L, 2) +
        Math.pow(lab1.a - lab2.a, 2) +
        Math.pow(lab1.b - lab2.b, 2)
      );
    }

    function analyzeColor() {
      const hex = colorInput.value;
      const targetRGB = hexToRGB(hex);
      const targetLab = rgbToLab(targetRGB);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      let matchCount = 0;
      const threshold = 60; // Start generous

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i + 1], b = data[i + 2], a = data[i + 3];
        if (a < 120) continue;

        const pixelLab = rgbToLab({ r, g, b });
        const diff = deltaE(targetLab, pixelLab);

        if (i % 4000 === 0) console.log(`Î”E: ${diff.toFixed(2)} vs ${r},${g},${b}`);

        if (diff < threshold) {
          data[i] = 255;    // highlight in red
          data[i + 1] = 0;
          data[i + 2] = 0;
          matchCount++;
        }
      }

      ctx.putImageData(imageData, 0, 0);

      const percent = (matchCount / (canvas.width * canvas.height) * 100).toFixed(2);
      document.getElementById("outputText").innerText = `Match: ${percent}% of pixels match ${hex.toUpperCase()}`;
    }
  </script>
</body>
</html>
